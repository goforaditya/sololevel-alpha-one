{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}
<style>
.entry-content h1, .entry-content h2, .entry-content h3 {
    font-weight: bold;
    margin-top: 1rem;
}

.entry-content p {
    margin-bottom: 1rem;
}

.entry-content code {
    background-color: #f5f5f5;
    padding: 2px 4px;
    border-radius: 4px;
    font-family: "Courier New", Courier, monospace;
}

.entry-content pre {
    background-color: #f5f5f5;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    font-family: "Courier New", Courier, monospace;
}

.entry-content ul {
    list-style-type: disc;
    padding-left: 1.5rem;
}

.entry-content ol {
    list-style-type: decimal;
    padding-left: 1.5rem;
}

.entry-content a {
    color: #1a73e8;
    text-decoration: underline;
}
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto space-y-8">
      <!-- Chat Interface -->
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 border border-gray-100">
        <div class="text-center mb-4 sm:mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Solo Level</h1>
            <p class="text-gray-600 mt-2 text-sm sm:text-base">Your AI-powered journal for personal growth</p>
        </div>
        
        <div id="chat-messages" class="h-72 sm:h-96 overflow-y-auto space-y-3 mb-4 sm:mb-6 rounded-lg bg-gray-50 p-3 sm:p-4 border">
            <!-- Messages will be inserted here via JavaScript -->
        </div>
        
        <form id="chat-form" class="space-y-3 sm:space-y-4">
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                <textarea 
                    id="message"
                    class="w-full p-2 sm:p-3 border rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                    rows="3"
                    placeholder="Tell me about your day..."
                ></textarea>
                <button 
                    type="submit"
                    class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 sm:px-4 rounded-lg flex items-center justify-center transition-colors text-sm sm:text-base gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="rotate-45">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    <span class="sm:hidden">Send</span>
                </button>
            </div>
            
            <button 
                onclick="createEntry()"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-2 sm:py-3 rounded-lg font-medium transition-colors text-sm sm:text-base flex items-center justify-center gap-2"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Create Journal Entry
            </button>
        </form>
      </div>

      <!-- Manual Entry Section -->
      <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">New Entry</h2>
        <div class="mb-4">
          {% if user %}
            <p class="text-gray-600">Posting as: <span class="font-medium">{{ user.username }}</span></p>
          {% else %}
            <p class="text-gray-600">Posting anonymously</p>
            <p class="mt-2"><a href="/login" class="text-blue-600 hover:text-blue-700">Login</a> to track your progress and get AI suggestions!</p>
          {% endif %}
        </div>
        
        <form id="entry-form" class="space-y-4">
          <textarea id="markdown-editor" name="content" rows="6" 
            class="w-full p-3 border rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="What's on your mind? (Max 5000 characters)" required></textarea>
          
          <div class="form-group">
            <label class="flex items-center hover:cursor-pointer">
              <input type="checkbox" name="is_public" class="mr-2 w-4 h-4 text-blue-600">
              <span class="text-gray-700">Make this entry public</span>
            </label>
          </div>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">
            Save Entry
          </button>
        </form>
      </div>

      <!-- Entries Display -->
      <div class="grid md:grid-cols-2 gap-6">
        {% if user %}
        <!-- User Entries -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Your Journey</h2>
          <div class="space-y-4">
            {% for entry in user_entries %}
            <a href="/entries/{{ entry.id }}" class="block hover:bg-gray-50 transition-colors">
            <div class="entry-card bg-gray-50 rounded-lg p-4 mb-4">
              <div class="entry-content text-gray-800">{{ render_markdown(entry.content) | safe }}</div>
              <div class="entry-meta flex justify-between items-center mt-3 text-sm text-gray-600">
                <span>{{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                {% if entry.is_public %}
                  <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Public</span>
                {% endif %}
                <h3>{{ entry.user_id.username if entry.user_id else "Anonymous" }}</h3>
              </div>
              
              {% if entry.activities %}
              <div class="activities mt-4 border-t pt-4">
                <h3 class="font-bold text-gray-800 mb-3">Suggested Activities:</h3>
                {% for activity in entry.activities %}
                <div class="activity-card bg-white p-4 rounded-lg shadow-sm mb-3">
                  <p class="text-gray-800 mb-3">{{ activity.description }}</p>
                  <form action="/activities/{{ activity.id }}/progress" method="POST" class="space-y-3">
                    <input type="range" name="progress" min="0" max="100" value="{{ activity.progress }}" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <input type="text" name="notes" placeholder="Add notes (optional)" 
                           value="{{ activity.notes or '' }}" 
                           class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors">
                      Update Progress
                    </button>
                  </form>
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Public Entries -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Community Stories</h2>
          <div class="space-y-4">
            {% for entry in public_entries %}
            <a href="/entries/{{ entry.id }}" class="block hover:bg-gray-50 transition-colors"></a>
            <div class="entry-card bg-gray-50 rounded-lg p-4 mb-4">
              <div class="entry-content text-gray-800">{{ entry.content }}</div>
              <div class="entry-meta flex justify-between items-center mt-3 text-sm text-gray-600">
                <span>{{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Public</span>
              </div>
            </div>
          </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message');
    
    // Initialize messages array
    let messages = [
        { role: 'assistant', content: "Hi! I'm here to help. How are you feeling today?" }
    ];

    // Function to display a message
    function displayMessage(message) {
        const messageDiv = document.createElement('div');
        // messageDiv.className = `p-2 rounded ${message.role === 'assistant' ? 'bg-blue-50' : 'bg-gray-50'}`;
        messageDiv.className = `max-w-[85%] sm:max-w-[80%] rounded-lg p-3 text-sm sm:text-base ${
            role === 'user' 
                ? 'bg-blue-600 text-white' 
                : 'bg-white border text-gray-800'
        }`
        messageDiv.textContent = message.content;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Display initial message
    displayMessage(messages[0]);

    // Handle chat form submission
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message to UI and messages array
        const userMessage = { role: 'user', content: message };
        messages.push(userMessage);
        displayMessage(userMessage);
        messageInput.value = '';

        try {
            // Send chat history to backend
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ messages: messages })
            });

            const data = await response.json();
            
            // Add assistant's response to UI and messages array
            // const assistantMessage = { role: 'assistant', content: data.response | "Sorry OpenAI Error" };
            const assistantMessage = { 
                role: 'assistant', 
                content: data.error ? "Sorry, there was an error: " + data.error : data.response 
            };
            messages.push(assistantMessage);
            displayMessage(assistantMessage);

        } catch (error) {
            console.error('Error:', error);
            displayMessage({ role: 'assistant', content: 'Sorry, there was an error. Please try again.' + error });
        }
    });

    // Handle entry form submission
    const entryForm = document.getElementById('entry-form');
    entryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('content', document.getElementById('markdown-editor').value);
        formData.append('entry_type', document.getElementById('type').value);
        formData.append('is_public', document.getElementById('is_public').checked);

        try {
            const response = await fetch('/entries', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            console.log('Success:', data);
            alert('Entry saved successfully!');

            // Clear form
            document.getElementById('content').value = '';
            document.getElementById('is_public').checked = false;

        } catch (error) {
            console.error('Error:', error);
            alert('Error saving entry. Please try again.');
        }
    });
});
</script>

<script>
    const simplemde = new SimpleMDE({ element: document.getElementById("markdown-editor") });
</script>
{% endblock %}
